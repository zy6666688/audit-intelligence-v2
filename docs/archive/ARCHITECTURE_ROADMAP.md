# ğŸš€ å®¡è®¡æ•°æ™ºæï¼šä¸‹ä¸€ä»£å®¡è®¡å¼•æ“æ¶æ„ä¼˜åŒ–è·¯çº¿å›¾

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**çŠ¶æ€**: è§„åˆ’ä¸­
**ç›®æ ‡**: æ„å»ºé«˜ååã€å¯è¿½æº¯ã€æ™ºèƒ½åŒ–çš„å®¡è®¡å·¥ä½œæµå¼•æ“ï¼Œå¯¹æ ‡ ComfyUI ä¸ Casewareã€‚

---

## ğŸ—ï¸ 1. æ ¸å¿ƒæ¶æ„æ¼”è¿›ç†å¿µ

**"ä»æµè§ˆå™¨è®¡ç®—è½¬å‘æµè§ˆå™¨ç¼–æ’"**

å½“å‰çš„æ¶æ„ä¸»è¦ä¾èµ–å‰ç«¯è¿›è¡Œæ•°æ®å¤„ç†ï¼Œè¿™åœ¨å¤„ç†å¤§è§„æ¨¡å®¡è®¡æ•°æ®æ—¶å­˜åœ¨æ€§èƒ½ç“¶é¢ˆã€‚æ–°çš„æ¶æ„å°†éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1.  **è½»å‰ç«¯ (Thin Client)**: å‰ç«¯ä»…ä½œä¸ºç”»å¸ƒ (Canvas) å’Œ æ§åˆ¶å° (Console)ï¼Œè´Ÿè´£ç¼–æ’é€»è¾‘ã€å‘é€æŒ‡ä»¤å’Œå±•ç¤ºé¢„è§ˆã€‚
2.  **é‡åç«¯ (Fat Backend)**: æ‰€æœ‰è®¡ç®—é€»è¾‘ï¼ˆæ•°æ®æ¸…æ´—ã€æ ¸å¯¹ã€AI åˆ†æï¼‰ä¸‹æ²‰è‡³åç«¯æˆ– Python è¿è¡Œæ—¶ã€‚
3.  **å¼•ç”¨ä¼ é€’ (Pass-by-Reference)**: èŠ‚ç‚¹ä¹‹é—´ä¸å†ä¼ é€’å…¨é‡ JSON æ•°æ®ï¼Œè€Œæ˜¯ä¼ é€’ **æ•°æ®å¥æŸ„ (Data Handle)**ã€‚

---

## ğŸ§© 2. æŠ€æœ¯é€‰å‹çŸ©é˜µ

| æ¨¡å— | å½“å‰æ–¹æ¡ˆ | **æ¨èå‡çº§æ–¹æ¡ˆ** | ç†ç”± |
| :--- | :--- | :--- | :--- |
| **æ¸²æŸ“å¼•æ“** | åŸç”Ÿ SVG | **AntV X6** æˆ– **Vue Flow** | è§£å†³ DOM æ€§èƒ½ç“¶é¢ˆï¼Œæ”¯æŒè™šæ‹Ÿæ»šåŠ¨ã€ç¼©æ”¾ã€å°åœ°å›¾ã€‚ |
| **æ‰§è¡Œæ¨¡å¼** | å‰ç«¯åŒæ­¥æ‰§è¡Œ | **åç«¯å¼‚æ­¥é˜Ÿåˆ— (BullMQ/Redis)** | æ”¯æŒè€—æ—¶ä»»åŠ¡ï¼Œé˜²æ­¢æµè§ˆå™¨å¡æ­»ï¼Œæ”¯æŒæŒä¹…åŒ–ã€‚ |
| **æ•°æ®æµè½¬** | JSON å¯¹è±¡ | **DuckDB / Parquet / Arrow** | ä¸“ä¸ºåˆ†æè®¾è®¡çš„åˆ—å¼å­˜å‚¨ï¼Œæ”¯æŒç™¾ä¸‡çº§è¡Œæ•°æ®ç§’çº§æŸ¥è¯¢ã€‚ |
| **è„šæœ¬å¼•æ“** | æ—  / JS | **Python (Pandas/Pyodide)** | å®¡è®¡å±Šé€šç”¨çš„æ•°æ®å¤„ç†è¯­è¨€ï¼Œç”Ÿæ€ä¸°å¯Œã€‚ |
| **çŠ¶æ€ç®¡ç†** | Vue Ref | **Pinia + Immer** | å¤„ç†æ’¤é”€/é‡åš (Undo/Redo) å’Œå¤æ‚å›¾çŠ¶æ€ã€‚ |

---

## ğŸ›¤ï¸ 3. å®æ–½é˜¶æ®µè§„åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šè¡¨ç°å±‚é‡æ„ (The Face)
**ç›®æ ‡**: è§£å†³æ¸²æŸ“æ€§èƒ½é—®é¢˜ï¼Œæä¾›æµç•…çš„ç¼–è¾‘ä½“éªŒã€‚

- [ ] **å¼•å…¥å›¾å½¢åº“**: åºŸå¼ƒ `NodeCanvasV2` çš„ SVG å®ç°ï¼Œè¿ç§»è‡³ X6 æˆ– Vue Flowã€‚
- [ ] **ç±»å‹ç³»ç»Ÿå¼ºåŒ–**: åœ¨ `NodeRegistry` ä¸­å®šä¹‰ä¸¥æ ¼çš„ `SocketType` (æ’æ§½ç±»å‹)ã€‚
    - `SocketType`: `TableRef`, `VoucherList`, `Money`, `Date`, `RiskScore`.
    - è¿çº¿æ—¶è‡ªåŠ¨æ ¡éªŒç±»å‹å…¼å®¹æ€§ï¼ˆä¾‹å¦‚ï¼šç¦æ­¢å°† "é‡‘é¢" è¿å…¥ "æ—¥æœŸ" æ’æ§½ï¼‰ã€‚
- [ ] **å­å›¾å°è£… (Compound Nodes)**: å®ç°â€œé€‰ä¸­å¤šä¸ªèŠ‚ç‚¹ -> æ‰“åŒ…â€åŠŸèƒ½ï¼Œç®€åŒ–å¤æ‚å®¡è®¡ç¨‹åºçš„è§†è§‰å‘ˆç°ã€‚

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®å±‚ä¸åè®®æ”¹é€  (The Brain)
**ç›®æ ‡**: å‰åç«¯è§£è€¦ï¼Œæ”¯æŒå¤§æ•°æ®é‡æµè½¬ã€‚

- [ ] **å®šä¹‰æ•°æ®å¥æŸ„åè®®**:
    ```typescript
    // èŠ‚ç‚¹é—´ä¼ é€’çš„æ ‡å‡†å¯¹è±¡
    export interface DataHandle {
      type: 'table' | 'file' | 'json' | 'image';
      refId: string; // æŒ‡å‘åç«¯æ•°æ®åº“è¡¨åæˆ–æ–‡ä»¶è·¯å¾„ (UUID)
      meta: {
        schema: any;
        rowCount: number;
        previewData: any[]; // ä»…æºå¸¦å‰ 20 è¡Œç”¨äº UI é¢„è§ˆ
      };
    }
    ```
- [ ] **å‰åç«¯åˆ†ç¦»æ‰§è¡Œ**:
    - å‰ç«¯ç‚¹å‡»â€œè¿è¡Œâ€ -> åºåˆ—åŒ– Graph JSON -> å‘é€ç»™åç«¯ã€‚
    - åç«¯è§£æä¾èµ–å›¾ -> ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ (Execution Plan)ã€‚
- [ ] **ä¸­é—´æ€æ¢é’ˆ (Data Probe)**: ç‚¹å‡»è¿çº¿æ—¶ï¼Œå‰ç«¯åˆ©ç”¨ `refId` å‘åç«¯è¯·æ±‚æ•°æ®é¢„è§ˆï¼ˆç±»ä¼¼äº SQL çš„ `SELECT * FROM refId LIMIT 50`ï¼‰ã€‚

### ç¬¬ä¸‰é˜¶æ®µï¼šå®¡è®¡åˆè§„ä¸æ™ºèƒ½åŒ– (The Soul)
**ç›®æ ‡**: æ»¡è¶³å®¡è®¡ç›‘ç®¡è¦æ±‚ï¼Œæå‡è‡ªåŠ¨åŒ–ç¨‹åº¦ã€‚

- [ ] **å®¡è®¡ç—•è¿¹ (Audit Trail / Event Sourcing)**:
    - è®°å½•æ¯ä¸€æ¬¡è¿è¡Œçš„â€œå¿«ç…§â€ï¼š`GraphTopology + InputParams + OutputRefIds + Timestamp`ã€‚
    - ç¡®ä¿åº•ç¨¿ç”Ÿæˆè¿‡ç¨‹å¯å¤ç°ã€ä¸å¯ç¯¡æ”¹ã€‚
- [ ] **AI å†³ç­–èŠ‚ç‚¹**:
    - å¼•å…¥ `Router Node` (è·¯ç”±èŠ‚ç‚¹)ï¼Œç”± LLM æ ¹æ®ä¸Šæ¸¸æ•°æ®ç‰¹å¾å†³å®šèµ°å“ªä¸ªåˆ†æ”¯ã€‚
    - åœºæ™¯ï¼š`[æ•°æ®è¾“å…¥] -> [AIåˆ†æé£é™©] -> (é«˜é£é™©åˆ†æ”¯/ä½é£é™©åˆ†æ”¯)`ã€‚
- [ ] **Office æ·±åº¦é›†æˆ**:
    - å®ç°æœåŠ¡ç«¯ç”Ÿæˆ Excel/Word åº•ç¨¿ï¼ˆåŸºäº Python `openpyxl` / `python-docx`ï¼‰ï¼Œè€Œéå‰ç«¯ç”Ÿæˆã€‚

---

## ğŸ“ 4. å…³é”®ä»£ç èŒƒå¼å‚è€ƒ

### 4.1 å®šä¹‰èŠ‚ç‚¹è§„æ ¼ (Node Specification)
å‚è€ƒ Blender/ComfyUI çš„å¼ºç±»å‹å®šä¹‰é£æ ¼ï¼š

```typescript
// src/core/types/NodeSpec.ts

export interface NodeInputSpec {
  name: string;
  type: 'Table' | 'String' | 'Float';
  label: string;
  required: boolean;
}

export interface NodeSpec {
  type: string; // e.g., 'FILTER_VOUCHER'
  category: 'DataProcessing' | 'AI' | 'Reporting';
  inputs: NodeInputSpec[];
  outputs: NodeInputSpec[];
  // æ‰§è¡Œé€»è¾‘ä»…åœ¨åç«¯å®šä¹‰ï¼Œå‰ç«¯ä»…ä¿å­˜é…ç½®
  defaultConfig: Record<string, any>; 
}
```

### 4.2 åç«¯æ‰§è¡Œå™¨é€»è¾‘ (Python ä¼ªä»£ç )
æ¨¡æ‹Ÿ ComfyUI çš„åç«¯æ‰§è¡Œæµï¼š

```python
# backend/executor.py

def execute_graph(graph_json):
    # 1. æ‹“æ‰‘æ’åº
    execution_order = topological_sort(graph_json)
    
    # 2. ä¸Šä¸‹æ–‡ç¼“å­˜ (Latent Cache)
    context = load_cache_context()
    
    for node_id in execution_order:
        node = graph_json['nodes'][node_id]
        
        # 3. å‡†å¤‡è¾“å…¥ (è§£æä¸Šæ¸¸å¥æŸ„)
        inputs = resolve_inputs(node, context)
        
        # 4. æ‰§è¡Œé€»è¾‘ (ä¸‹æ²‰åˆ° Panda/DuckDB)
        # æ— è®ºæ•°æ®å¤šå¤§ï¼Œåªä¼ é€’å¼•ç”¨ table_name
        result_ref = dispatch_task(node.type, inputs) 
        
        # 5. æ›´æ–°ä¸Šä¸‹æ–‡
        context[node_id] = result_ref
        
        # 6. æ¨é€çŠ¶æ€ç»™å‰ç«¯
        websocket.emit('node_complete', { nodeId: node_id, preview: get_preview(result_ref) })
```

---

## âš–ï¸ 5. å¯¹æ¯”åˆ†ææ€»ç»“

### vs å…ˆè¿›å®¡è®¡è½¯ä»¶ (Caseware/TeamMate)
*   **æ¬ ç¼º**: æ•°æ®å®Œæ•´æ€§æ ¡éªŒã€è·¨åº•ç¨¿å‹¾ç¨½å…³ç³»ã€å¤§è§„æ¨¡æ•°æ®å¤„ç†èƒ½åŠ›ã€‚
*   **å¯¹ç­–**: å¼•å…¥ DuckDB ä½œä¸ºåµŒå…¥å¼æ•°æ®å¼•æ“ï¼›å®æ–½ Event Sourcing ä¿è¯ç—•è¿¹ç®¡ç†ã€‚

### vs èŠ‚ç‚¹ç¼–è¾‘å™¨ (ComfyUI/Blender)
*   **æ¬ ç¼º**: æ¸²æŸ“æ€§èƒ½ (DOM vs Canvas/GPU)ã€æ‰§è¡Œæ¨¡å¼ (æ¨æ¨¡å¼ vs æ‹‰æ¨¡å¼/ä¼˜å…ˆçº§é˜Ÿåˆ—)ã€‚
*   **å¯¹ç­–**: è¿ç§»è‡³ X6/Vue Flowï¼›åç«¯å®ç°åŸºäºæ‹“æ‰‘æ’åºçš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ã€‚

---

**æ‰§è¡Œå»ºè®®**:
è¯·ä¼˜å…ˆå®Œæˆ **"Phase 1 - å›¾å½¢åº“è¿ç§»"** å’Œ **"Phase 2 - æ•°æ®å¥æŸ„åŒ–"**ï¼Œè¿™æ˜¯ç³»ç»Ÿèƒ½æ‰¿è½½çœŸå®å®¡è®¡ä¸šåŠ¡çš„åŸºçŸ³ã€‚
