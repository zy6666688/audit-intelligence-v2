# ğŸš€ V3èŠ‚ç‚¹ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹

**ç‰ˆæœ¬**: 3.0.0  
**æ›´æ–°æ—¶é—´**: 2025-12-02

---

## ğŸ“‹ å‰ç½®è¦æ±‚

ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ï¼š
- âœ… Node.js >= 16.x
- âœ… TypeScript >= 4.x
- âœ… PostgreSQLï¼ˆç”¨äºå…ƒæ•°æ®ï¼‰
- âœ… Redisï¼ˆå¯é€‰ï¼Œç”¨äºç¼“å­˜ï¼‰

---

## ğŸ¯ 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

### Step 1: åˆå§‹åŒ–V3èŠ‚ç‚¹

åœ¨åç«¯ä»£ç ä¸­æ·»åŠ ï¼š

```typescript
// packages/backend/src/index.ts

import { initializeV3Nodes } from './nodes/v3';

// ... å…¶ä»–å¯¼å…¥å’Œåˆå§‹åŒ– ...

// åˆå§‹åŒ–V3èŠ‚ç‚¹ç³»ç»Ÿ
const v3Registry = initializeV3Nodes();

console.log('âœ… V3 Nodes ready:', v3Registry.getStats());
```

### Step 2: åˆ›å»ºæµ‹è¯•æ•°æ®

```typescript
// test-data.ts

const sampleOrders = {
  type: 'Records',
  schema: [
    { name: 'order_id', type: 'string', required: true, description: 'Order ID' },
    { name: 'item', type: 'string', required: true, description: 'Item' },
    { name: 'amount', type: 'number', required: true, description: 'Amount' },
    { name: 'date', type: 'date', required: true, description: 'Date' }
  ],
  data: [
    { order_id: 'ORD001', item: 'Computer', amount: 5000, date: '2025-01-01' },
    { order_id: 'ORD002', item: 'Printer', amount: 800, date: '2025-01-02' },
    { order_id: 'ORD003', item: 'Mouse', amount: 50, date: '2025-01-03' }
  ],
  metadata: {
    source: 'test',
    timestamp: new Date(),
    version: '1.0.0',
    traceId: 'test-001',
    nodeId: 'test',
    executionId: 'test-001'
  },
  rowCount: 3,
  columnCount: 4
};

const sampleDeliveries = {
  // ç±»ä¼¼ç»“æ„...
};

const sampleInvoices = {
  // ç±»ä¼¼ç»“æ„...
};
```

### Step 3: æ‰§è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹

```typescript
import { nodeRegistryV3 } from './nodes/v3';

// åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡
const context = {
  executionId: 'test-exec-001',
  nodeId: 'test-node',
  graphId: 'test-graph',
  userId: 'auditor-001',
  logger: console
};

// æ‰§è¡Œä¸‰å•åŒ¹é…
const result = await nodeRegistryV3.execute(
  'audit.three_doc_match',
  {
    orders: sampleOrders,
    deliveries: sampleDeliveries,
    invoices: sampleInvoices
  },
  {
    amountTolerance: 0.01,
    dateToleranceDays: 7,
    fuzzyItemMatch: true
  },
  context
);

console.log('âœ… Match result:', result);
console.log('ğŸ“Š Matches:', result.outputs.matches.rowCount);
console.log('âš ï¸  Mismatches:', result.outputs.mismatches.rowCount);
console.log('ğŸ”¥ Risks:', result.outputs.risks.summary.total);
```

---

## ğŸ¨ å®Œæ•´å®¡è®¡å·¥ä½œæµç¤ºä¾‹

### åœºæ™¯ï¼šä»CSVåˆ°å®¡è®¡åº•ç¨¿

```typescript
import { nodeRegistryV3 } from './nodes/v3';
import * as fs from 'fs';
import * as csvParse from 'csv-parse/sync';

async function runAuditWorkflow() {
  const context = {
    executionId: `exec-${Date.now()}`,
    nodeId: 'workflow',
    graphId: 'audit-workflow-001',
    userId: 'auditor-zhang',
    logger: console
  };

  // 1ï¸âƒ£ è¯»å–CSVå¹¶å¯¼å…¥
  const csvData = fs.readFileSync('./data/transactions.csv', 'utf-8');
  const parsedData = csvParse.parse(csvData, { columns: true });

  const recordsResult = await nodeRegistryV3.execute(
    'input.records',
    {},
    {
      data: parsedData,
      autoDetectTypes: true,
      validateData: true
    },
    context
  );

  console.log('âœ… Step 1: Imported', recordsResult.outputs.records.rowCount, 'records');

  // 2ï¸âƒ£ ä¸‰å•åŒ¹é…
  const matchResult = await nodeRegistryV3.execute(
    'audit.three_doc_match',
    {
      orders: recordsResult.outputs.records,
      deliveries: deliveryRecords, // å‡è®¾å·²æœ‰
      invoices: invoiceRecords      // å‡è®¾å·²æœ‰
    },
    {
      amountTolerance: 0.01,
      dateToleranceDays: 7
    },
    { ...context, nodeId: 'three-doc-match' }
  );

  console.log('âœ… Step 2: Matched', matchResult.outputs.matches.rowCount, 'documents');

  // 3ï¸âƒ£ èµ„é‡‘å¾ªç¯æ£€æµ‹
  const loopResult = await nodeRegistryV3.execute(
    'audit.fund_loop_detect',
    {
      flows: bankFlowRecords // å‡è®¾å·²æœ‰
    },
    {
      timeWindowDays: 7,
      minLoopAmount: 100000,
      returnRatio: 0.8
    },
    { ...context, nodeId: 'fund-loop' }
  );

  console.log('âœ… Step 3: Detected', loopResult.outputs.loops.rowCount, 'fund loops');

  // 4ï¸âƒ£ åˆå¹¶é£é™©å¹¶AIè¯„åˆ†
  const scoreResult = await nodeRegistryV3.execute(
    'ai.fraud_scorer',
    {
      vouchers: recordsResult.outputs.records,
      flows: bankFlowRecords,
      existingRisks: matchResult.outputs.risks
    },
    {
      sensitivity: 'high',
      enableAI: true,
      aiModel: 'gpt-3.5-turbo'
    },
    { ...context, nodeId: 'ai-scorer', ai: aiProvider }
  );

  console.log('âœ… Step 4: AI Score =', scoreResult.outputs.scores.data[4].score);

  // 5ï¸âƒ£ ç”Ÿæˆå®¡è®¡åº•ç¨¿
  const workpaperResult = await nodeRegistryV3.execute(
    'output.workpaper_generator',
    {
      evidence: scoreResult.outputs.evidence,
      risks: scoreResult.outputs.risk,
      findings: matchResult.outputs.mismatches
    },
    {
      template: 'detailed',
      format: 'pdf',
      includeEvidence: true,
      watermark: true
    },
    { ...context, nodeId: 'workpaper-gen' }
  );

  console.log('âœ… Step 5: Workpaper generated:', workpaperResult.outputs.document.data[0].url);

  return {
    records: recordsResult.outputs.records.rowCount,
    matches: matchResult.outputs.matches.rowCount,
    mismatches: matchResult.outputs.mismatches.rowCount,
    loops: loopResult.outputs.loops.rowCount,
    score: scoreResult.outputs.scores.data[4].score,
    workpaper: workpaperResult.outputs.document.data[0].url
  };
}

// è¿è¡Œ
runAuditWorkflow()
  .then(result => {
    console.log('\nğŸ‰ Audit workflow completed!');
    console.log('ğŸ“Š Summary:', result);
  })
  .catch(error => {
    console.error('âŒ Workflow failed:', error);
  });
```

---

## ğŸ” èŠ‚ç‚¹ä½¿ç”¨æŒ‡å—

### 1. records_inputï¼ˆè®°å½•è¾“å…¥ï¼‰

**ç”¨é€”**: å¯¼å…¥CSV/JSONæ•°æ®å¹¶è‡ªåŠ¨æ¨æ–­ç±»å‹

```typescript
const result = await nodeRegistryV3.execute(
  'input.records',
  {},
  {
    data: [
      { id: 1, name: 'å¼ ä¸‰', amount: 1000, date: '2025-01-01' },
      { id: 2, name: 'æå››', amount: 2000, date: '2025-01-02' }
    ],
    autoDetectTypes: true,  // è‡ªåŠ¨æ¨æ–­å­—æ®µç±»å‹
    validateData: true      // éªŒè¯æ•°æ®å®Œæ•´æ€§
  },
  context
);

// è¾“å‡º
result.outputs.records  // Recordsç±»å‹
```

**ä½•æ—¶ä½¿ç”¨**:
- âœ… å¯¼å…¥CSV/Excelæ•°æ®
- âœ… ä»APIè·å–çš„JSONæ•°æ®
- âœ… æ•°æ®åº“æŸ¥è¯¢ç»“æœ

### 2. three_doc_matchï¼ˆä¸‰å•åŒ¹é…ï¼‰

**ç”¨é€”**: è®¢å•-å‘è´§å•-å‘ç¥¨ä¸‰å•åŒ¹é…

```typescript
const result = await nodeRegistryV3.execute(
  'audit.three_doc_match',
  {
    orders: ordersRecords,
    deliveries: deliveryRecords,
    invoices: invoiceRecords
  },
  {
    amountTolerance: 0.01,        // 1%é‡‘é¢å®¹å·®
    dateToleranceDays: 7,         // 7å¤©æ—¥æœŸå®¹å·®
    fuzzyItemMatch: true,         // å¯ç”¨æ¨¡ç³Šå•†å“åŒ¹é…
    minMatchScore: 0.8            // æœ€å°åŒ¹é…åˆ†æ•°
  },
  context
);

// è¾“å‡º
result.outputs.matches      // åŒ¹é…æˆåŠŸçš„è®°å½•
result.outputs.mismatches   // å¼‚å¸¸è®°å½•
result.outputs.risks        // é£é™©é›†åˆ
result.outputs.evidence     // å®¡è®¡è¯æ®
```

**ä½•æ—¶ä½¿ç”¨**:
- âœ… é‡‡è´­å®¡è®¡
- âœ… é”€å”®å®¡è®¡
- âœ… å‘ç¥¨çœŸå®æ€§éªŒè¯
- âœ… è™šå¼€å‘ç¥¨æ£€æµ‹

### 3. fund_loop_detectï¼ˆèµ„é‡‘é—­ç¯æ£€æµ‹ï¼‰

**ç”¨é€”**: æ£€æµ‹èµ„é‡‘ç©ºè½¬å’Œå¾ªç¯äº¤æ˜“

```typescript
const result = await nodeRegistryV3.execute(
  'audit.fund_loop_detect',
  {
    flows: bankFlowRecords,
    accounts: accountRecords  // å¯é€‰
  },
  {
    timeWindowDays: 7,        // 7å¤©æ—¶é—´çª—å£
    minLoopAmount: 100000,    // æœ€å°é‡‘é¢10ä¸‡
    returnRatio: 0.8,         // 80%å›æµæ¯”ä¾‹
    maxDepth: 6,              // æœ€å¤§æœç´¢æ·±åº¦
    minLoopLength: 2          // æœ€å°å¾ªç¯é•¿åº¦
  },
  context
);

// è¾“å‡º
result.outputs.loops   // æ£€æµ‹åˆ°çš„å¾ªç¯
result.outputs.risks   // é£é™©è¯„ä¼°
result.outputs.graph   // èµ„é‡‘æµå‘å›¾
result.outputs.evidence // å®¡è®¡è¯æ®
```

**ä½•æ—¶ä½¿ç”¨**:
- âœ… èµ„é‡‘å®¡è®¡
- âœ… æ´—é’±æ£€æµ‹
- âœ… è™šæ„äº¤æ˜“è¯†åˆ«
- âœ… å…³è”æ–¹èµ„é‡‘å¾€æ¥

### 4. ai_fraud_scorerï¼ˆAIèˆå¼Šè¯„åˆ†ï¼‰

**ç”¨é€”**: åŸºäºè§„åˆ™å’ŒAIçš„ç»¼åˆèˆå¼Šè¯„åˆ†

```typescript
const result = await nodeRegistryV3.execute(
  'ai.fraud_scorer',
  {
    vouchers: voucherRecords,     // å¯é€‰
    flows: bankFlowRecords,       // å¯é€‰
    contracts: contractRecords,   // å¯é€‰
    existingRisks: riskSet        // å¯é€‰
  },
  {
    sensitivity: 'high',          // low/medium/high
    enableAI: true,               // å¯ç”¨AIåˆ†æ
    aiModel: 'gpt-4',            // AIæ¨¡å‹é€‰æ‹©
    threshold: 70                 // é£é™©é˜ˆå€¼
  },
  { ...context, ai: aiProvider }  // éœ€è¦AI provider
);

// è¾“å‡º
result.outputs.risk       // ç»¼åˆé£é™©è¯„ä¼°
result.outputs.scores     // è¯¦ç»†è¯„åˆ†è¡¨
result.outputs.evidence   // AIåˆ†æè¯æ®
```

**ä½•æ—¶ä½¿ç”¨**:
- âœ… ç»¼åˆé£é™©è¯„ä¼°
- âœ… èˆå¼Šé¢„è­¦
- âœ… å®¡è®¡æŠ½æ ·å†³ç­–
- âœ… é£é™©ç­‰çº§åˆ’åˆ†

### 5. workpaper_generatorï¼ˆåº•ç¨¿ç”Ÿæˆï¼‰

**ç”¨é€”**: è‡ªåŠ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿

```typescript
const result = await nodeRegistryV3.execute(
  'output.workpaper_generator',
  {
    evidence: evidenceData,
    risks: riskSet,
    findings: findingsRecords,  // å¯é€‰
    metadata: projectMetadata   // å¯é€‰
  },
  {
    template: 'detailed',       // standard/detailed/summary
    includeEvidence: true,      // åŒ…å«è¯æ®æ˜ç»†
    includeCharts: true,        // åŒ…å«å›¾è¡¨
    format: 'pdf',              // pdf/html/docx
    watermark: true             // æ·»åŠ æ°´å°
  },
  { ...context, storage: storageProvider }
);

// è¾“å‡º
result.outputs.workpaper  // åº•ç¨¿æ•°æ®
result.outputs.document   // æ–‡æ¡£ä¿¡æ¯ï¼ˆURLã€å¤§å°ç­‰ï¼‰
```

**ä½•æ—¶ä½¿ç”¨**:
- âœ… ç”Ÿæˆå®¡è®¡åº•ç¨¿
- âœ… ç¼–åˆ¶å·¥ä½œæŠ¥å‘Š
- âœ… è¯æ®å½’æ¡£
- âœ… åˆè§„æ€§æ–‡æ¡£

---

## ğŸ¯ å¸¸è§åœºæ™¯

### åœºæ™¯1ï¼šæ‰¹é‡å‘ç¥¨éªŒè¯

```typescript
// 1. å¯¼å…¥å‘ç¥¨æ•°æ®
const invoices = await nodeRegistryV3.execute('input.records', ...);

// 2. ä¸‰å•åŒ¹é…éªŒè¯
const matched = await nodeRegistryV3.execute('audit.three_doc_match', {
  orders, deliveries, invoices: invoices.outputs.records
}, ...);

// 3. AIçœŸä¼ªæ£€æµ‹ï¼ˆå¦‚æœæœ‰å‘ç¥¨å›¾ç‰‡ï¼‰
// const aiCheck = await nodeRegistryV3.execute('ai.fake_invoice', ...);

// 4. ç”ŸæˆéªŒè¯æŠ¥å‘Š
const report = await nodeRegistryV3.execute('output.workpaper_generator', {
  evidence: matched.outputs.evidence,
  risks: matched.outputs.risks
}, ...);
```

### åœºæ™¯2ï¼šèµ„é‡‘å®¡è®¡

```typescript
// 1. å¯¼å…¥é“¶è¡Œæµæ°´
const flows = await nodeRegistryV3.execute('input.records', ...);

// 2. æ£€æµ‹èµ„é‡‘å¾ªç¯
const loops = await nodeRegistryV3.execute('audit.fund_loop_detect', {
  flows: flows.outputs.records
}, ...);

// 3. AIé£é™©è¯„åˆ†
const score = await nodeRegistryV3.execute('ai.fraud_scorer', {
  flows: flows.outputs.records,
  existingRisks: loops.outputs.risks
}, { enableAI: true, ...});

// 4. ç”Ÿæˆåº•ç¨¿
const workpaper = await nodeRegistryV3.execute('output.workpaper_generator', ...);
```

### åœºæ™¯3ï¼šå¹´åº¦å®¡è®¡

```typescript
// ç«¯åˆ°ç«¯å·¥ä½œæµï¼ˆä½¿ç”¨å›¾æ‰§è¡Œï¼‰
const graph = {
  nodes: [
    { id: 'n1', type: 'input.records', config: {...} },
    { id: 'n2', type: 'audit.three_doc_match', config: {...} },
    { id: 'n3', type: 'audit.fund_loop_detect', config: {...} },
    { id: 'n4', type: 'ai.fraud_scorer', config: {...} },
    { id: 'n5', type: 'output.workpaper_generator', config: {...} }
  ],
  connections: [
    { from: {nodeId: 'n1', portId: 'records'}, to: {nodeId: 'n2', portId: 'orders'} },
    { from: {nodeId: 'n2', portId: 'risks'}, to: {nodeId: 'n4', portId: 'existingRisks'} },
    // ... æ›´å¤šè¿æ¥
  ]
};

const results = await nodeRegistryV3.executeGraph(graph, {}, context);
```

---

## ğŸ”§ é…ç½®AI Provider

### OpenAIé…ç½®

```typescript
import OpenAI from 'openai';

const aiProvider = {
  chat: async (messages, options) => {
    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    const response = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages,
      ...options
    });
    return response.choices[0].message.content;
  },
  
  embedding: async (text) => {
    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    const response = await openai.embeddings.create({
      model: 'text-embedding-ada-002',
      input: text
    });
    return response.data[0].embedding;
  }
};
```

### é…ç½®å­˜å‚¨

```typescript
import { S3Client } from '@aws-sdk/client-s3';

const storageProvider = {
  save: async (path, data) => {
    // ä¿å­˜åˆ°S3/MinIO
    const url = await uploadToS3(path, data);
    return url;
  },
  
  load: async (path) => {
    // ä»S3/MinIOåŠ è½½
    const data = await downloadFromS3(path);
    return data;
  }
};
```

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹èŠ‚ç‚¹ç»Ÿè®¡

```typescript
const stats = nodeRegistryV3.getStats();
console.log('ğŸ“Š Registry Stats:', stats);
// {
//   totalNodes: 5,
//   categories: { input: 1, audit: 2, analysis: 1, output: 1 },
//   byCapability: { cacheable: 4, aiPowered: 1, parallel: 4 }
// }
```

### æœç´¢èŠ‚ç‚¹

```typescript
const nodes = nodeRegistryV3.searchNodes('match');
console.log('ğŸ” Found nodes:', nodes.map(n => n.type));
// ['audit.three_doc_match']
```

### æ™ºèƒ½æ¨è

```typescript
const recommendations = nodeRegistryV3.recommendNextNodes('Records');
console.log('ğŸ’¡ Recommended:', recommendations.map(n => n.type));
// ['audit.three_doc_match', 'audit.fund_loop_detect', ...]
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†å¤§æ•°æ®é‡ï¼Ÿ

**A**: V3èŠ‚ç‚¹æ”¯æŒæµå¼å¤„ç†å’Œåˆ†æ‰¹å¤„ç†ï¼š

```typescript
// æ–¹æ³•1ï¼šåˆ†æ‰¹å¤„ç†
const batchSize = 1000;
for (let i = 0; i < totalRecords; i += batchSize) {
  const batch = records.slice(i, i + batchSize);
  const result = await nodeRegistryV3.execute(...);
}

// æ–¹æ³•2ï¼šä½¿ç”¨ç¼–è¯‘å™¨çš„å¹¶è¡Œæ‰§è¡Œ
const plan = compiler.generateParallelPlan(graph);
// ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–å¹¶è¡Œæ‰§è¡Œ
```

### Q2: AIèŠ‚ç‚¹å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: å¯ç”¨ç¼“å­˜å’Œé™çº§ç­–ç•¥ï¼š

```typescript
// 1. å¯ç”¨ç¼“å­˜ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰
// AIèŠ‚ç‚¹ä¼šè‡ªåŠ¨ç¼“å­˜ç»“æœ

// 2. ä½¿ç”¨Fallback
// AIèŠ‚ç‚¹å¤±è´¥æ—¶ä¼šè‡ªåŠ¨é™çº§åˆ°è§„åˆ™å¼•æ“

// 3. è°ƒæ•´æ•æ„Ÿåº¦
const config = {
  sensitivity: 'low',  // é™ä½AIè°ƒç”¨é¢‘ç‡
  enableAI: false      // å®Œå…¨ç¦ç”¨AI
};
```

### Q3: å¦‚ä½•è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Ÿ

**A**: ç»§æ‰¿BaseNodeV3ï¼š

```typescript
import { BaseNodeV3 } from './nodes/v3';

class MyCustomNode extends BaseNodeV3 {
  getManifest() {
    return {
      type: 'custom.my_node',
      // ... å®Œæ•´manifest
    };
  }

  async execute(inputs, config, context) {
    // è‡ªå®šä¹‰é€»è¾‘
    return this.wrapSuccess(outputs, duration, context);
  }
}

// æ³¨å†Œ
nodeRegistryV3.register(new MyCustomNode());
```

---

## ğŸ“š æ›´å¤šèµ„æº

- ğŸ“– [èŠ‚ç‚¹å¼€å‘æŒ‡å—](./packages/backend/src/nodes/v3/README.md)
- ğŸ“– [æ¶æ„é‡æ„è®¡åˆ’](./æ¶æ„é‡æ„è®¡åˆ’.md)
- ğŸ“– [Phase A MVPå®ŒæˆæŠ¥å‘Š](./Phase_A_MVPå®ŒæˆæŠ¥å‘Š.md)
- ğŸ“– [APIæ–‡æ¡£](#) (å¾…è¡¥å……)

---

## ğŸŠ å¼€å§‹ä½¿ç”¨ï¼

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. ç¼–è¯‘TypeScript
npm run build

# 3. è¿è¡Œæµ‹è¯•
npm run test

# 4. å¯åŠ¨æœåŠ¡
npm run start
```

**ç¥æ‚¨å®¡è®¡æ„‰å¿«ï¼** ğŸš€

---

**æ›´æ–°æ—¶é—´**: 2025-12-02  
**ç‰ˆæœ¬**: 3.0.0
