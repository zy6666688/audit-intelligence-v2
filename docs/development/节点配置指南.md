# V3èŠ‚ç‚¹é…ç½®æŒ‡å—

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¶é—´**: 2025-12-02

---

## ğŸ“š ç›®å½•

1. [é…ç½®æ¦‚è¿°](#é…ç½®æ¦‚è¿°)
2. [è¾“å…¥èŠ‚ç‚¹é…ç½®](#è¾“å…¥èŠ‚ç‚¹é…ç½®)
3. [é¢„å¤„ç†èŠ‚ç‚¹é…ç½®](#é¢„å¤„ç†èŠ‚ç‚¹é…ç½®)
4. [å®¡è®¡èŠ‚ç‚¹é…ç½®](#å®¡è®¡èŠ‚ç‚¹é…ç½®)
5. [é…ç½®æ¨¡æ¿](#é…ç½®æ¨¡æ¿)
6. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)

---

## é…ç½®æ¦‚è¿°

### é…ç½®ç»“æ„

æ‰€æœ‰V3èŠ‚ç‚¹éµå¾ªç»Ÿä¸€çš„é…ç½®ç»“æ„ï¼š

```typescript
{
  // èŠ‚ç‚¹ç‰¹å®šé…ç½®
  config: {
    // å¿…éœ€é…ç½®é¡¹
    data: [...],
    
    // å¯é€‰é…ç½®é¡¹
    option1: value1,
    option2: value2
  },
  
  // æ‰§è¡Œä¸Šä¸‹æ–‡
  context: {
    nodeId: string,
    executionId: string,
    userId: string,
    logger?: Logger,
    cache?: Cache,
    ai?: AIService
  }
}
```

### é…ç½®ä¼˜å…ˆçº§

1. **æ˜¾å¼é…ç½®** - è°ƒç”¨æ—¶ä¼ å…¥çš„é…ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **é»˜è®¤é…ç½®** - èŠ‚ç‚¹å®šä¹‰çš„defaultValue
3. **ç¯å¢ƒé…ç½®** - ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶

---

## è¾“å…¥èŠ‚ç‚¹é…ç½®

### 1. RecordsInputNode

```typescript
{
  // å¿…éœ€
  data: Array<Record<string, any>>,
  
  // å¯é€‰
  autoDetectTypes: boolean = true,    // è‡ªåŠ¨æ£€æµ‹å­—æ®µç±»å‹
  validateData: boolean = true,        // éªŒè¯æ•°æ®
  schema?: FieldSchema[],             // è‡ªå®šä¹‰schema
  
  // é«˜çº§é€‰é¡¹
  cache: boolean = true,
  batchSize: number = 1000
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const config = {
  data: csvData,
  autoDetectTypes: true,
  validateData: true
};
```

---

### 2. VoucherInputNode

```typescript
{
  // å¿…éœ€
  data: Array<Record<string, any>>,
  
  // æ•°æ®æº
  source: 'csv' | 'excel' | 'erp' = 'csv',
  
  // éªŒè¯é€‰é¡¹
  validateBalance: boolean = true,     // éªŒè¯å€Ÿè´·å¹³è¡¡
  checkAttachments: boolean = false,   // æ£€æŸ¥é™„ä»¶
  checkApproval: boolean = false,      // æ£€æŸ¥å®¡æ‰¹
  autoMapFields: boolean = true,       // è‡ªåŠ¨å­—æ®µæ˜ å°„
  
  // å®¹å·®é…ç½®
  balanceTolerance: number = 0.01     // å€Ÿè´·å¹³è¡¡å®¹å·®
}
```

**å­—æ®µæ˜ å°„é…ç½®**:
```typescript
// è‡ªåŠ¨æ˜ å°„æ”¯æŒçš„å­—æ®µå˜ä½“
const fieldVariants = {
  voucher_no: ['voucher_no', 'voucherno', 'no', 'å‡­è¯å·'],
  date: ['date', 'voucher_date', 'æ—¥æœŸ', 'å‡­è¯æ—¥æœŸ'],
  debit_amount: ['debit_amount', 'debit', 'å€Ÿæ–¹', 'å€Ÿæ–¹é‡‘é¢'],
  credit_amount: ['credit_amount', 'credit', 'è´·æ–¹', 'è´·æ–¹é‡‘é¢']
};
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  data: voucherData,
  source: 'erp',
  validateBalance: true,
  checkAttachments: true,
  balanceTolerance: 0.01
}
```

---

### 3. ContractInputNode

```typescript
{
  // å¿…éœ€
  data: Array<Record<string, any>>,
  
  // æ•°æ®æº
  source: 'pdf' | 'word' | 'image' | 'text' = 'pdf',
  
  // å¤„ç†é€‰é¡¹
  extractText: boolean = true,         // æå–æ–‡æœ¬
  recognizeElements: boolean = true,   // è¯†åˆ«åˆåŒè¦ç´ 
  detectRisks: boolean = true,         // æ£€æµ‹é£é™©æ¡æ¬¾
  
  // OCRé…ç½®ï¼ˆsourceä¸ºimageæ—¶ï¼‰
  ocrProvider?: 'aliyun' | 'baidu' | 'tencent',
  ocrConfidence?: number = 0.8,
  
  // é£é™©é…ç½®
  riskClauses?: string[],             // è‡ªå®šä¹‰é£é™©å…³é”®è¯
  riskThreshold?: number = 0.7
}
```

**é£é™©å…³é”®è¯**:
```typescript
const defaultRiskClauses = [
  'è¿çº¦', 'èµ”å¿', 'è§£é™¤åˆåŒ', 'ç»ˆæ­¢',
  'ä¿è¯é‡‘', 'ç½šæ¬¾', 'æ»çº³é‡‘', 'é€¾æœŸ',
  'è´£ä»»', 'äº‰è®®', 'ä»²è£', 'è¯‰è®¼'
];
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  data: contracts,
  source: 'pdf',
  extractText: true,
  recognizeElements: true,
  detectRisks: true,
  riskClauses: [...defaultRiskClauses, 'ä¸å¯æŠ—åŠ›']
}
```

---

### 4. BankFlowInputNode

```typescript
{
  // å¿…éœ€
  data: Array<Record<string, any>>,
  
  // é“¶è¡Œç±»å‹
  bankType: 'icbc' | 'ccb' | 'abc' | 'boc' | 'cmb' | 'auto' = 'auto',
  
  // å¤„ç†é€‰é¡¹
  categorizeTransactions: boolean = true,  // äº¤æ˜“åˆ†ç±»
  detectAnomalies: boolean = true,        // å¼‚å¸¸æ£€æµ‹
  consolidateAccounts: boolean = false,   // åˆå¹¶è´¦æˆ·
  
  // å¼‚å¸¸æ£€æµ‹é˜ˆå€¼
  roundAmountThreshold: number = 0.5,     // æ•´æ•°é‡‘é¢æ¯”ä¾‹é˜ˆå€¼
  highFreqThreshold: number = 10,         // é«˜é¢‘äº¤æ˜“é˜ˆå€¼ï¼ˆç¬”/å¤©ï¼‰
  largeAmountThreshold: number = 1000000  // å¤§é¢äº¤æ˜“é˜ˆå€¼
}
```

**é“¶è¡Œæ ¼å¼æ”¯æŒ**:
```typescript
const bankFormats = {
  icbc: {  // å·¥å•†é“¶è¡Œ
    dateField: 'transaction_date',
    amountField: 'trans_amount'
  },
  ccb: {   // å»ºè®¾é“¶è¡Œ
    dateField: 'tradedate',
    amountField: 'money'
  }
  // ... å…¶ä»–é“¶è¡Œ
};
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  data: bankFlowData,
  bankType: 'icbc',
  categorizeTransactions: true,
  detectAnomalies: true,
  highFreqThreshold: 15
}
```

---

### 5. InvoiceInputNode

```typescript
{
  // å¿…éœ€
  data: Array<Record<string, any>>,
  
  // æ•°æ®æº
  source: 'csv' | 'excel' | 'image' | 'api' = 'csv',
  
  // éªŒè¯é€‰é¡¹
  validateFormat: boolean = true,      // éªŒè¯æ ¼å¼
  detectDuplicates: boolean = true,    // æ£€æµ‹é‡å¤
  verifyTax: boolean = true,          // éªŒè¯ç¨é¢
  ocrEnabled: boolean = false,        // å¯ç”¨OCR
  
  // éªŒè¯è§„åˆ™
  taxTolerance: number = 0.01,        // ç¨é¢å®¹å·®
  invoiceNoPattern?: RegExp,          // å‘ç¥¨å·æ ¼å¼
  taxNoPattern?: RegExp               // ç¨å·æ ¼å¼
}
```

**æ ¼å¼éªŒè¯è§„åˆ™**:
```typescript
const validationRules = {
  invoiceNo: /^\d{8}$/,               // 8ä½æ•°å­—
  invoiceCode: /^\d{10,12}$/,         // 10-12ä½æ•°å­—
  taxNo: /^[\dA-Z]{15,18}$/          // 15-18ä½æ•°å­—æˆ–å­—æ¯
};
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  data: invoiceData,
  source: 'csv',
  validateFormat: true,
  detectDuplicates: true,
  verifyTax: true,
  taxTolerance: 0.01
}
```

---

## é¢„å¤„ç†èŠ‚ç‚¹é…ç½®

### 6. OCRExtractNode

```typescript
{
  // OCRæœåŠ¡å•†
  provider: 'aliyun' | 'baidu' | 'tencent' | 'azure' | 'google' = 'aliyun',
  
  // è¯­è¨€è®¾ç½®
  language: 'zh' | 'en' | 'auto' = 'auto',
  
  // è´¨é‡æ§åˆ¶
  minConfidence: number = 0.5,        // æœ€å°ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
  
  // æ€§èƒ½é€‰é¡¹
  enableCache: boolean = true,        // å¯ç”¨ç¼“å­˜
  batchSize: number = 10,            // æ‰¹å¤„ç†å¤§å°
  timeout: number = 30000,           // è¶…æ—¶æ—¶é—´ï¼ˆmsï¼‰
  
  // é«˜çº§é€‰é¡¹
  enhanceImage: boolean = false,      // å›¾åƒå¢å¼º
  detectOrientation: boolean = false  // æ£€æµ‹æ–¹å‘
}
```

**æœåŠ¡å•†é…ç½®**:
```typescript
const providerConfig = {
  aliyun: {
    endpoint: process.env.ALIYUN_OCR_ENDPOINT,
    accessKeyId: process.env.ALIYUN_ACCESS_KEY_ID,
    accessKeySecret: process.env.ALIYUN_ACCESS_KEY_SECRET
  },
  baidu: {
    apiKey: process.env.BAIDU_API_KEY,
    secretKey: process.env.BAIDU_SECRET_KEY
  }
  // ... å…¶ä»–æœåŠ¡å•†
};
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  provider: 'aliyun',
  language: 'zh',
  minConfidence: 0.8,
  enableCache: true,
  batchSize: 10
}
```

---

### 7. FieldMapperNode

```typescript
{
  // å¿…éœ€
  mappings: Array<{
    sourceField: string,
    targetField: string,
    targetType?: 'string' | 'number' | 'boolean' | 'date',
    transform?: string,
    formula?: string,
    defaultValue?: any,
    condition?: {
      field: string,
      operator: '==' | '!=' | '>' | '<' | '>=' | '<=',
      value: any
    }
  }>,
  
  // å¯é€‰
  keepUnmapped: boolean = true,       // ä¿ç•™æœªæ˜ å°„å­—æ®µ
  strictMode: boolean = false         // ä¸¥æ ¼æ¨¡å¼
}
```

**æ˜ å°„è§„åˆ™ç¤ºä¾‹**:
```typescript
{
  mappings: [
    // ç®€å•é‡å‘½å
    {
      sourceField: 'old_name',
      targetField: 'new_name',
      targetType: 'string'
    },
    
    // ç±»å‹è½¬æ¢
    {
      sourceField: 'age',
      targetField: 'age',
      targetType: 'number'
    },
    
    // è½¬æ¢å‡½æ•°
    {
      sourceField: 'name',
      targetField: 'name',
      transform: 'uppercase'
    },
    
    // å…¬å¼è®¡ç®—
    {
      sourceField: 'salary',
      targetField: 'after_tax',
      formula: 'salary * (1 - tax_rate)'
    },
    
    // æ¡ä»¶æ˜ å°„
    {
      sourceField: 'amount',
      targetField: 'level',
      condition: {
        field: 'amount',
        operator: '>',
        value: 10000
      },
      defaultValue: 'low'
    }
  ],
  keepUnmapped: true
}
```

---

### 8. NormalizeDataNode

```typescript
{
  // æ—¥æœŸæ ‡å‡†åŒ–
  dateFormat: string = 'YYYY-MM-DD',
  
  // é‡‘é¢æ ‡å‡†åŒ–
  amountUnit: 'yuan' | 'wan' | 'yi' = 'yuan',
  
  // å­—ç¬¦ä¸²å¤„ç†
  trimStrings: boolean = true,
  lowercaseStrings: boolean = false,
  
  // æ•°æ®æ¸…ç†
  removeEmptyRows: boolean = true,
  fillNullValues: boolean = false,
  
  // ç©ºå€¼æ˜ å°„
  nullValueMap?: Record<string, any>,
  
  // ç¼–ç è½¬æ¢
  encoding?: 'utf8' | 'gbk' | 'gb2312'
}
```

**æ—¥æœŸæ ¼å¼é€‰é¡¹**:
```typescript
const dateFormats = {
  'YYYY-MM-DD': '2025-01-01',
  'MM/DD/YYYY': '01/01/2025',
  'DD/MM/YYYY': '01/01/2025',
  'YYYYå¹´MMæœˆDDæ—¥': '2025å¹´01æœˆ01æ—¥'
};
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  dateFormat: 'YYYY-MM-DD',
  amountUnit: 'yuan',
  trimStrings: true,
  removeEmptyRows: true,
  fillNullValues: true,
  nullValueMap: {
    amount: 0,
    name: 'æœªçŸ¥'
  }
}
```

---

### 9. DeduplicateNode

```typescript
{
  // å»é‡æ–¹æ³•
  method: 'exact' | 'fuzzy' | 'hash' | 'composite' = 'exact',
  
  // å­—æ®µé…ç½®
  fields?: string[],                  // ç”¨äºå»é‡çš„å­—æ®µï¼ˆç©º=å…¨éƒ¨ï¼‰
  
  // ä¿ç•™ç­–ç•¥
  keepStrategy: 'first' | 'last' | 'best' = 'first',
  
  // æ¨¡ç³ŠåŒ¹é…ï¼ˆmethod='fuzzy'æ—¶ï¼‰
  fuzzyThreshold: number = 0.8,       // ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰
  
  // åŒ¹é…é€‰é¡¹
  caseSensitive: boolean = false,     // å¤§å°å†™æ•æ„Ÿ
  ignoreWhitespace: boolean = true    // å¿½ç•¥ç©ºæ ¼
}
```

**å»é‡ç­–ç•¥è¯´æ˜**:
```typescript
const strategies = {
  first: 'ä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„è®°å½•',
  last: 'ä¿ç•™æœ€åå‡ºç°çš„è®°å½•',
  best: 'ä¿ç•™æ•°æ®æœ€å®Œæ•´çš„è®°å½•ï¼ˆéç©ºå­—æ®µæœ€å¤šï¼‰'
};
```

**é…ç½®ç¤ºä¾‹**:
```typescript
// ç²¾ç¡®å»é‡
{
  method: 'exact',
  fields: ['email'],
  keepStrategy: 'first'
}

// æ¨¡ç³Šå»é‡
{
  method: 'fuzzy',
  fuzzyThreshold: 0.9,
  caseSensitive: false,
  ignoreWhitespace: true
}
```

---

## å®¡è®¡èŠ‚ç‚¹é…ç½®

### 10. ThreeDocMatchNode

```typescript
{
  // å®¹å·®é…ç½®
  amountTolerance: number = 0.01,     // é‡‘é¢å®¹å·®ï¼ˆ1%ï¼‰
  dateToleranceDays: number = 7,      // æ—¥æœŸå®¹å·®ï¼ˆå¤©ï¼‰
  
  // åŒ¹é…è§„åˆ™
  requireAllThree: boolean = false,    // æ˜¯å¦è¦æ±‚ä¸‰å•é½å…¨
  partialMatch: boolean = true,        // å…è®¸éƒ¨åˆ†åŒ¹é…
  
  // å­—æ®µæ˜ å°„
  orderIdField?: string = 'order_id',
  deliveryIdField?: string = 'delivery_id',
  invoiceIdField?: string = 'invoice_id'
}
```

**é…ç½®ç¤ºä¾‹**:
```typescript
{
  amountTolerance: 0.01,
  dateToleranceDays: 7,
  requireAllThree: false
}
```

---

### 11. FundLoopDetectNode

```typescript
{
  // æ£€æµ‹å‚æ•°
  maxLoopLength: number = 10,         // æœ€å¤§å¾ªç¯é•¿åº¦
  minLoopAmount: number = 10000,      // æœ€å°å¾ªç¯é‡‘é¢
  timeWindowDays: number = 30,        // æ—¶é—´çª—å£ï¼ˆå¤©ï¼‰
  
  // ç®—æ³•é€‰é¡¹
  algorithm: 'dfs' | 'bfs' = 'dfs',
  maxDepth: number = 5,
  
  // é£é™©è¯„ä¼°
  riskThreshold: number = 0.7
}
```

---

## é…ç½®æ¨¡æ¿

### å®Œæ•´å®¡è®¡æµç¨‹é…ç½®

```typescript
const auditPipelineConfig = {
  // 1. æ•°æ®å¯¼å…¥
  import: {
    voucher: {
      source: 'erp',
      validateBalance: true,
      checkAttachments: true
    },
    invoice: {
      source: 'csv',
      validateFormat: true,
      verifyTax: true
    },
    bankFlow: {
      bankType: 'icbc',
      categorizeTransactions: true,
      detectAnomalies: true
    }
  },
  
  // 2. æ•°æ®é¢„å¤„ç†
  preprocess: {
    normalize: {
      dateFormat: 'YYYY-MM-DD',
      amountUnit: 'yuan',
      removeEmptyRows: true
    },
    deduplicate: {
      method: 'exact',
      keepStrategy: 'first'
    }
  },
  
  // 3. å®¡è®¡åˆ†æ
  audit: {
    threeDocMatch: {
      amountTolerance: 0.01,
      dateToleranceDays: 7
    },
    fundLoop: {
      maxLoopLength: 10,
      minLoopAmount: 10000
    },
    aiScorer: {
      model: 'gpt-4',
      threshold: 0.7
    }
  },
  
  // 4. è¾“å‡º
  output: {
    workpaper: {
      template: 'standard',
      format: 'pdf',
      includeEvidence: true
    }
  }
};
```

---

## ç¯å¢ƒé…ç½®

### ç¯å¢ƒå˜é‡

```bash
# OCRæœåŠ¡é…ç½®
ALIYUN_OCR_ENDPOINT=https://ocr.aliyuncs.com
ALIYUN_ACCESS_KEY_ID=your_access_key
ALIYUN_ACCESS_KEY_SECRET=your_secret_key

BAIDU_API_KEY=your_api_key
BAIDU_SECRET_KEY=your_secret_key

# AIæœåŠ¡é…ç½®
OPENAI_API_KEY=your_openai_key
OPENAI_MODEL=gpt-4

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:pass@localhost:5432/audit_db

# ç¼“å­˜é…ç½®
REDIS_URL=redis://localhost:6379
CACHE_TTL=3600

# æ€§èƒ½é…ç½®
MAX_BATCH_SIZE=1000
WORKER_THREADS=4
```

### é…ç½®æ–‡ä»¶

`config/nodes.json`:
```json
{
  "defaults": {
    "cache": {
      "enabled": true,
      "ttl": 3600
    },
    "performance": {
      "batchSize": 100,
      "timeout": 30000
    }
  },
  "nodes": {
    "input.voucher": {
      "balanceTolerance": 0.01,
      "checkAttachments": false
    },
    "preprocess.ocr": {
      "provider": "aliyun",
      "minConfidence": 0.8
    }
  }
}
```

---

## é…ç½®éªŒè¯

### éªŒè¯é…ç½®æ­£ç¡®æ€§

```typescript
import { nodeRegistryV3 } from './nodes/v3';

function validateConfig(nodeType: string, config: any): boolean {
  const node = nodeRegistryV3.getNode(nodeType);
  const manifest = node.getManifest();
  
  // æ£€æŸ¥å¿…éœ€é…ç½®
  for (const configDef of manifest.config) {
    if (configDef.required && !(configDef.id in config)) {
      throw new Error(`Missing required config: ${configDef.id}`);
    }
  }
  
  return true;
}

// ä½¿ç”¨
try {
  validateConfig('input.voucher', {
    data: voucherData,
    source: 'erp'
  });
  console.log('âœ… Configuration valid');
} catch (error) {
  console.error('âŒ Configuration error:', error.message);
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-12-02  
**ç»´æŠ¤è€…**: Audit System Team
